function getEnd(e){var t=0;try{t=e.buffered.end(0)||0,t=parseInt(1e3*t+1)/1e3}catch(e){}return t}var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var e=document.createElement("canvas");return!!window.WebGLRenderingContext&&(e.getContext("webgl")||e.getContext("experimental-webgl"))}catch(e){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var e=document.createElement("div");return e.id="webgl-error-message",e.style.fontFamily="monospace",e.style.fontSize="13px",e.style.fontWeight="normal",e.style.textAlign="center",e.style.background="#fff",e.style.color="#000",e.style.padding="1.5em",e.style.width="400px",e.style.margin="5em auto 0",this.webgl||(e.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),e},addGetWebGLMessage:function(e){var t,i,s;e=e||{},t=void 0!==e.parent?e.parent:document.body,i=void 0!==e.id?e.id:"oldie",s=Detector.getWebGLErrorMessage(),s.id=i,t.appendChild(s)}};!function(e,t,i,s,n,o){function a(t,i){this.element=t,this.options=e.extend({},l,i),this._defaults=l,this._name=r,this.init()}var r="Valiant360",l={crossOrigin:"anonymous",clickAndDrag:!1,keyboardControls:!0,fov:35,fovMin:3,fovMax:100,hideControls:!1,lon:0,lat:0,loop:"loop",muted:!0,volume:.5,debug:!1,flatProjection:!1,autoplay:!0};a.prototype={init:function(){this._time=(new Date).getTime(),this._controls={},this._id=this.generateUUID(),this._requestAnimationId="",this._isVideo=!1,this._isPhoto=!1,this._isFullscreen=!1,this._mouseDown=!1,this._dragStart={},this._lat=this.options.lat,this._lon=this.options.lon,this._fov=this.options.fov,this._originalWidth=e(this.element).find("canvas").width(),this._originalHeight=e(this.element).find("canvas").height(),e(this.element).addClass("Valiant360_default"),this.options.keyboardControls&&!e(this.element).attr("tabindex")&&e(this.element).attr("tabindex","1"),this.createMediaPlayer(),this.createControls()},generateUUID:function(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?i:7&i|8).toString(16)});return t},createMediaPlayer:function(){var s=this;this._scene=new t.Scene,this._camera=new t.PerspectiveCamera(this._fov,e(this.element).width()/e(this.element).height(),.1,1e3),this._camera.setLens(this._fov),this._renderer=i.webgl?new t.WebGLRenderer:new t.CanvasRenderer,this._renderer.setSize(e(this.element).width(),e(this.element).height()),this._renderer.autoClear=!1,this._renderer.setClearColor(3355443,1),e(this.element).append(this._renderer.domElement);var a=function(){s._texture.generateMipmaps=!1,s._texture.minFilter=t.LinearFilter,s._texture.magFilter=t.LinearFilter,s._texture.format=t.RGBFormat,s._mesh=new t.Mesh(new t.SphereGeometry(500,80,50),new t.MeshBasicMaterial({map:s._texture})),s._mesh.scale.x=-1,s._scene.add(s._mesh),s.animate()};if(e(this.element).attr("data-photo-src"))this._isPhoto=!0,t.ImageUtils.crossOrigin=this.options.crossOrigin,this._texture=t.ImageUtils.loadTexture(e(this.element).attr("data-photo-src")),a();else{this._isVideo=!0;var r='<div class="loading"> \t\t\t\t\t\t\t\t\t\t<div class="icon waiting-icon"></div> \t\t\t\t\t\t\t\t\t\t<div class="icon error-icon"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i></div> \t\t\t\t\t\t\t\t\t</div>';e(this.element).append(r),this.showWaiting(),this._video=n.createElement("video"),this._video.setAttribute("crossorigin",this.options.crossOrigin),this._video.style.display="none",e(this.element).append(this._video),this._video.loop=this.options.loop,this._video.muted=this.options.muted,this._video.volume=this.options.volume,this._video.addEventListener("ended",function(){}),this._video.addEventListener("progress",function(){var e=null;s._video&&s._video.buffered&&s._video.buffered.length>0&&s._video.buffered.end&&s._video.duration?e=s._video.buffered.end(0)/s._video.duration:s._video&&s._video.bytesTotal!==o&&s._video.bytesTotal>0&&s._video.bufferedBytes!==o&&(e=s._video.bufferedBytes/s._video.bytesTotal);Math.round(100*e)}),this._video.addEventListener("error",function(e){console.error(s._video.error),s.showError()}),this._video.addEventListener("timeupdate",function(){if(this.paused===!1){var t=100*this.currentTime/this.duration;e(s.element).find(".controlsWrapper > .valiant-progress-bar")[0].children[0].setAttribute("style","width:"+t+"%;"),e(s.element).find(".controlsWrapper > .valiant-progress-bar")[0].children[1].setAttribute("style","width:"+(100-t)+"%;");var i=Math.floor(this.duration/60),n=Math.floor(this.duration-60*i),o=Math.floor(this.currentTime/60),a=Math.floor(this.currentTime-60*o),r=i+":"+(n<10?"0"+n:n),l=o+":"+(a<10?"0"+a:a);e(s.element).find(".controls .timeLabel").html(l+" / "+r)}});var l="Microsoft Internet Explorer"==navigator.appName||!(!navigator.userAgent.match(/Trident/)&&!navigator.userAgent.match(/rv 11/));l?(this._videocanvas=n.createElement("canvas"),this._texture=new t.Texture(this._videocanvas),this._video.addEventListener("loadedmetadata",function(){s._videocanvas.width=s._video.videoWidth,s._videocanvas.height=s._video.videoHeight,a()})):this._texture=new t.Texture(this._video);var h=e(this.element).attr("data-video-src");s._video.src=h,e(s._video).bind("canplaythrough",function(){s.options.autoplay===!0&&(s.hideWaiting(),s.play(),s._videoReady=!0);var t=s._video.duration,i=setInterval(function(){var n=getEnd(s._video);if(n<t){var o=n/t*100+"%";return void e("body").find(".buffer_pro").css("width",o)}return n==t?void e("body").find(".buffer_pro").css("width","100%"):void clearInterval(i)},300)}),l||a()}},createControls:function(){var t=this.options.muted?"fa-volume-off":"fa-volume-up",i=this.options.autoplay?"fa-pause":"fa-play",s=100*this.options.volume+"%",n='               <div class="controlsWrapper">                <div class="valiant-progress-bar">                    <div style="width: 0;"></div><div style="width: 100%;"></div><span class="buffer_pro" style="position:absolute;left:0;height:5px;top:0;background:#ccc;"></span>                </div>                <div class="controls">                     <a href="#" class="playButton button fa '+i+'"></a> \t\t\t\t\t<div class="audioControl">\t\t\t\t\t\t<a href="#" class="muteButton button fa '+t+'"></a> \t\t\t\t\t\t<div class="volumeControl">\t\t\t\t\t\t\t<div class="volumeBar" style="width:'+s+';">\t\t\t\t\t\t\t\t<div class="volumeProgress"></div>\t\t\t\t\t\t\t\t<div class="volumeCursor"></div>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>\t\t\t\t\t</div>\t\t\t\t\t<span class="timeLabel"></span>                     <a href="#" class="fullscreenButton button fa fa-expand"></a><a class="fr open_local_file hide"></a><a class="fr vr_btn"></a>                </div>               </div>            ';e(this.element).append(n,!0),e(this.element).append('<div class="timeTooltip">00:00</div>',!0),this.options.hideControls&&e(this.element).find(".controls").hide(),this.attachControlEvents()},attachControlEvents:function(){var t=this;this.element.addEventListener("mousemove",this.onMouseMove.bind(this),!1),this.element.addEventListener("touchmove",this.onMouseMove.bind(this),!1),this.element.addEventListener("mousewheel",this.onMouseWheel.bind(this),!1),this.element.addEventListener("DOMMouseScroll",this.onMouseWheel.bind(this),!1),this.element.addEventListener("mousedown",this.onMouseDown.bind(this),!1),this.element.addEventListener("touchstart",this.onMouseDown.bind(this),!1),this.element.addEventListener("mouseup",this.onMouseUp.bind(this),!1),this.element.addEventListener("touchend",this.onMouseUp.bind(this),!1),this.options.keyboardControls&&(this.element.addEventListener("keydown",this.onKeyDown.bind(this),!1),this.element.addEventListener("keyup",this.onKeyUp.bind(this),!1),this.element.addEventListener("keyArrowPress",this.onKeyArrowPress.bind(this),!1),this.element.addEventListener("click",function(){e(t.element).focus()},!1)),e(t.element).find(".controlsWrapper > .valiant-progress-bar")[0].addEventListener("click",this.onProgressClick.bind(this),!1),e(t.element).find(".controlsWrapper > .valiant-progress-bar")[0].addEventListener("mousemove",this.onProgressMouseMove.bind(this),!1),e(t.element).find(".controlsWrapper > .valiant-progress-bar")[0].addEventListener("mouseout",this.onProgressMouseOut.bind(this),!1),e(n).on("webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange",this.fullscreen.bind(this)),e(s).resize(function(){t.resizeGL(e(t.element).width(),e(t.element).height())}),e(this.element).find(".playButton").click(function(i){i.preventDefault(),e(this).hasClass("fa-pause")?(e(this).removeClass("fa-pause").addClass("fa-play"),t.pause()):(e(this).removeClass("fa-play").addClass("fa-pause"),t.play())}),n.onkeydown=function(i){var s=i.keyCode,o=e(t.element)[0];27==s&&(o.requestFullscreen?n.exitFullscreen():o.msRequestFullscreen?n.msExitFullscreen():o.mozRequestFullScreen?n.mozCancelFullScreen():o.webkitRequestFullscreen&&n.webkitExitFullscreen())},e(this.element).on("dblclick",function(i){i.preventDefault();var s=e(t.element)[0];e(this).find(".fullscreenButton").hasClass("fa-expand")?s.requestFullscreen?s.requestFullscreen():s.msRequestFullscreen?s.msRequestFullscreen():s.mozRequestFullScreen?s.mozRequestFullScreen():s.webkitRequestFullscreen&&s.webkitRequestFullscreen():s.requestFullscreen?n.exitFullscreen():s.msRequestFullscreen?n.msExitFullscreen():s.mozRequestFullScreen?n.mozCancelFullScreen():s.webkitRequestFullscreen&&n.webkitExitFullscreen()}),e(this.element).find(".fullscreenButton").click(function(i){i.preventDefault();var s=e(t.element)[0];e(this).hasClass("fa-expand")?s.requestFullscreen?s.requestFullscreen():s.msRequestFullscreen?s.msRequestFullscreen():s.mozRequestFullScreen?s.mozRequestFullScreen():s.webkitRequestFullscreen&&s.webkitRequestFullscreen():s.requestFullscreen?n.exitFullscreen():s.msRequestFullscreen?n.msExitFullscreen():s.mozRequestFullScreen?n.mozCancelFullScreen():s.webkitRequestFullscreen&&n.webkitExitFullscreen()}),e(this.element).find(".muteButton").click(function(i){i.preventDefault(),e(this).hasClass("fa-volume-off")?(e(this).removeClass("fa-volume-off").addClass("fa-volume-up"),t._video.muted=!1):(e(this).removeClass("fa-volume-up").addClass("fa-volume-off"),t._video.muted=!0)}),e(this.element).find(".controlsWrapper .volumeControl").mousedown(this.onVolumeMouseDown.bind(this)).mouseup(this.onVolumeMouseUp.bind(this)).mouseleave(this.onVolumeMouseUp.bind(this)).mousemove(this.onVolumeMouseMove.bind(this)),e(this._video).on("volumechange",this.onVolumeChange.bind(this))},onMouseMove:function(t){this._onPointerDownPointerX=t.clientX,this._onPointerDownPointerY=-t.clientY,this.relativeX=t.pageX-e(this.element).find("canvas").offset().left,this._onPointerDownLon=this._lon,this._onPointerDownLat=this._lat;var i,s;this.options.clickAndDrag?this._mouseDown&&(i=t.pageX-this._dragStart.x,s=t.pageY-this._dragStart.y,this._dragStart.x=t.pageX,this._dragStart.y=t.pageY,this._lon+=i,this._lat-=s):(i=t.pageX-e(this.element).find("canvas").offset().left,s=t.pageY-e(this.element).find("canvas").offset().top,this._lon=i/e(this.element).find("canvas").width()*430-225,this._lat=s/e(this.element).find("canvas").height()*-180+90)},onMouseWheel:function(e){var t=-.01;e.wheelDeltaY?this._fov-=e.wheelDeltaY*t:e.wheelDelta?this._fov-=e.wheelDelta*t:e.detail&&(this._fov+=1*e.detail),this._fov<this.options.fovMin?this._fov=this.options.fovMin:this._fov>this.options.fovMax&&(this._fov=this.options.fovMax),this._camera.setLens(this._fov),e.preventDefault()},onMouseDown:function(e){this._mouseDown=!0,this._dragStart.x=e.pageX,this._dragStart.y=e.pageY},onProgressClick:function(t){if(this._isVideo&&this._video.readyState===this._video.HAVE_ENOUGH_DATA){this.showWaiting();var i=this.relativeX/e(this.element).find("canvas").width()*100;e(this.element).find(".controlsWrapper > .valiant-progress-bar")[0].children[0].setAttribute("style","width:"+i+"%;"),e(this.element).find(".controlsWrapper > .valiant-progress-bar")[0].children[1].setAttribute("style","width:"+(100-i)+"%;"),this._video.currentTime=this._video.duration*i/100,console.dir(this._video.buffered.end(0))}},onProgressMouseMove:function(t){var i=this.relativeX/e(this.element).find("canvas").width()*100;if(i){var s=e(this.element).find(".timeTooltip"),n=this.relativeX-s.width()/2;n=n<0?0:Math.min(n,e(this.element).find("canvas").width()-s.outerWidth()),s.css({left:n+"px"}),s.show();var o=i/100*this._video.duration,a=Math.floor(o/60),r=Math.floor(o-60*a);s.html(a+":"+(r<10?"0"+r:r))}},onProgressMouseOut:function(t){e(this.element).find(".timeTooltip").hide()},onMouseUp:function(e){this._mouseDown=!1},onKeyDown:function(e){var t=e.keyCode;if(t>=37&&t<=40){e.preventDefault(),this._keydown=!0;var i=n.createEvent("CustomEvent");i.initCustomEvent("keyArrowPress",!0,!0,{keyCode:t}),this.element.dispatchEvent(i)}},onKeyUp:function(e){var t=e.keyCode;t>=37&&t<=40&&(e.preventDefault(),this._keydown=!1)},onKeyArrowPress:function(e){if(this._keydown){var t=e.detail?e.detail.keyCode:null,i=3,s=50,o=this.element;switch(e.preventDefault(),t){case 37:this._lon-=i;break;case 39:this._lon+=i;break;case 38:this._lat+=i;break;case 40:this._lat-=i}setTimeout(function(){var e=n.createEvent("CustomEvent");e.initCustomEvent("keyArrowPress",!0,!0,{keyCode:t}),o.dispatchEvent(e)},s)}},onVolumeMouseDown:function(e){e.preventDefault(),this._volumeMouseDown=!0,this.onVolumeMouseMove(e)},onVolumeMouseUp:function(e){e.preventDefault(),this._volumeMouseDown=!1},onVolumeMouseMove:function(t){if(t.preventDefault(),this._volumeMouseDown){var i=e(this.element).find(".controlsWrapper .volumeControl"),s=(this.relativeX-i.offset().left+e(".valiantPhoto ").offset().left+i.find(".volumeBar > .volumeCursor").width()/2)/i.width()*100;s>=0&&s<=100&&(this._video.volume=s/100)}},onVolumeChange:function(t){var i=1!=this._video.muted||this._volumeMouseDown?100*this._video.volume:0;e(this.element).find(".controlsWrapper .volumeControl > .volumeBar").css({width:i+"%"});var s=e(this.element).find(".muteButton");(i>0&&s.hasClass("fa-volume-off")||0==i&&s.hasClass("fa-volume-up"))&&s.click()},animate:function(){if(this._requestAnimationId=requestAnimationFrame(this.animate.bind(this)),this._isVideo&&this._video.readyState===this._video.HAVE_ENOUGH_DATA&&(this._videocanvas&&this._videocanvas.getContext("2d").drawImage(this._video,0,0,this._videocanvas.width,this._videocanvas.height),"undefined"!=typeof this._texture)){var e=(new Date).getTime();e-this._time>=30&&(this._texture.needsUpdate=!0,this._time=e)}this.render()},render:function(){this._lat=Math.max(-85,Math.min(85,this._lat)),this._phi=(90-this._lat)*Math.PI/180,this._theta=this._lon*Math.PI/180;var e=500*Math.sin(this._phi)*Math.cos(this._theta),i=500*Math.cos(this._phi),s=500*Math.sin(this._phi)*Math.sin(this._theta);this._camera.lookAt(new t.Vector3(e,i,s)),this.options.flatProjection?(this._camera.position.x=0,this._camera.position.y=0,this._camera.position.z=0):(this._camera.position.x=-e,this._camera.position.y=-i,this._camera.position.z=-s),this._renderer.clear(),this._renderer.render(this._scene,this._camera)},play:function(){this._video.play(),e(".video_play_container .suspend").hide()},pause:function(){this._video.pause(),e(".video_play_container .suspend").show()},loadVideo:function(e){this._video.src=e},unloadVideo:function(){this.pause(),this._video.src="",this._video.removeAttribute("src")},loadPhoto:function(e){this._texture=t.ImageUtils.loadTexture(e)},fullscreen:function(){e(this.element).find("a.fa-expand").length>0?(this.resizeGL(screen.width,screen.height),e(this.element).addClass("fullscreen"),e(this.element).find("a.fa-expand").removeClass("fa-expand").addClass("fa-compress"),this._isFullscreen=!0):(this.resizeGL(this._originalWidth,this._originalHeight),e(this.element).removeClass("fullscreen"),e(this.element).find("a.fa-compress").removeClass("fa-compress").addClass("fa-expand"),this._isFullscreen=!1)},resizeGL:function(e,t){this._renderer.setSize(e,t),this._camera.aspect=e/t,this._camera.updateProjectionMatrix()},showWaiting:function(){var t=e(this.element).find(".loading");t.find(".waiting-icon").show(),t.find(".error-icon").hide(),t.show()},hideWaiting:function(){e(this.element).find(".loading").hide()},showError:function(){var t=e(this.element).find(".loading");t.find(".waiting-icon").hide(),t.find(".error-icon").show(),t.show()},destroy:function(){s.cancelAnimationFrame(this._requestAnimationId),this._requestAnimationId="",this._texture.dispose(),this._scene.remove(this._mesh),this._isVideo&&this.unloadVideo(),e(this._renderer.domElement).remove()}},e.fn[r]=function(t){var i=arguments;return this.each(function(){if("object"!=typeof t&&t){if(this.plugin[t])return this.plugin[t].apply(this.plugin,Array.prototype.slice.call(i,1))}else this.plugin=new a(this,t),e.data(this,"plugin_"+r)||e.data(this,"plugin_"+r,this.plugin)})}}(jQuery,THREE,Detector,window,document),$(this).hover(function(){},function(){});